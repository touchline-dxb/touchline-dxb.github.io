<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Touchline — Player of the Day Poster Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1: #052244;
    --bg2: #0b3b72;
    --accent: #1b66c4;
    --muted: #9fb7dd;
    --card: #0e2336;
    --white: #ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Poppins,system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(180deg,#041a36 0%, #081a2b 100%);}
  .app{max-width:1200px; margin:18px auto; display:flex; gap:18px; padding:14px; align-items:flex-start;}
  .panel{width:360px; min-width:280px; background:rgba(255,255,255,0.03); border-radius:12px; padding:16px; color:var(--white); box-shadow:0 8px 30px rgba(0,0,0,0.6); display:flex; flex-direction:column; gap:10px;}
  .panel h2{font-family:Montserrat, sans-serif; font-size:18px; margin:0 0 4px}
  label{font-size:13px; color:var(--muted); display:block; margin-top:8px}
  input[type="text"], select, .file-drop, button, input[type="range"]{width:100%}
  .file-drop{background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; text-align:center; position:relative; cursor:pointer; color:var(--muted)}
  .file-drop input{position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer}
  .row{display:flex; gap:8px}
  .half{flex:1}
  .btn{background:var(--accent); color:white; border:0; padding:10px; border-radius:8px; cursor:pointer; font-weight:700}
  .ghost{background:transparent; border:1px solid rgba(255,255,255,0.06)}
  .muted{color:var(--muted); font-size:13px}
  .small{font-size:12px;color:var(--muted)}
  .control-group{background:rgba(255,255,255,0.015); padding:10px; border-radius:8px; margin-top:8px}
  .stage{flex:1; display:flex; flex-direction:column; align-items:center; gap:12px}
  .canvas-card{background:linear-gradient(180deg,var(--card), #05213a); padding:14px; border-radius:12px; box-shadow:0 14px 40px rgba(2,8,20,0.6); width:100%; max-width:820px}
  .preview-outer{width:100%; aspect-ratio:1/1; background:transparent; border-radius:10px; overflow:hidden; position:relative; display:block}
  canvas#poster{width:100%; height:100%; display:block; background:transparent}
  .bottom-controls{display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:6px}
  .right-controls{display:flex; gap:8px; align-items:center}
  @media (max-width:980px){ .app{flex-direction:column; padding:10px} .panel{width:100%; order:2} .canvas-card{order:1; width:100%} }
  .badge{display:inline-block; background:var(--accent); color:white; padding:6px 10px; border-radius:6px; font-weight:700}
  .muted-note{font-size:12px;color:var(--muted); margin-top:6px}
  .file-preview{display:flex;gap:8px;align-items:center}
  .file-preview img{width:48px;height:48px;border-radius:6px;object-fit:cover;border:2px solid rgba(255,255,255,0.04)}
  select{padding:10px; border-radius:8px; background:rgba(255,255,255,0.02); border:0; color:var(--white)}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Touchline poster generator">

  <aside class="panel" aria-label="Controls">
    <h2>Poster Generator — Touchline</h2>
    <div class="muted">Template: <span class="badge">Player of the Day</span></div>

    <label>Background</label>
    <select id="bgSelect" aria-label="Background selector">
      <option value="touchline">Touchline Blue (default)</option>
      <option value="red">Red Energy</option>
      <option value="gold">Gold Champion</option>
      <option value="green">Green Victory</option>
      <option value="upload">Upload Custom Background…</option>
    </select>
    <div class="file-drop" id="bgDrop" style="display:none">Drop background image here
      <input id="bgFile" type="file" accept="image/*">
    </div>

    <label>Team photo (main)</label>
    <div class="file-drop" id="teamDrop">Click or drag & drop team photo
      <input id="teamFile" type="file" accept="image/*">
    </div>

    <label>Player portrait</label>
    <div class="file-drop" id="playerDrop">Click or drag & drop player portrait
      <input id="playerFile" type="file" accept="image/*">
    </div>

    <label>Logo (optional)</label>
    <div class="file-drop" id="logoDrop">Upload logo
      <input id="logoFile" type="file" accept="image/*">
    </div>

    <div class="control-group">
      <label>Player name</label>
      <input id="playerName" type="text" value="EZAAAN" />

      <label>Age group (badge)</label>
      <input id="ageLabel" type="text" value="UNDER 11" />

      <div class="row">
        <div class="half">
          <label>Date</label>
          <input id="dateField" type="text" value="07 - NOVEMBER - 2025" />
        </div>
        <div class="half">
          <label>Academy</label>
          <input id="academy" type="text" value="TOUCHLINE FOOTBALL ACADEMY" />
        </div>
      </div>
    </div>

    <div class="control-group">
      <div class="inline-label">Team photo: zoom</div>
      <input id="teamZoom" type="range" min="0.2" max="4" step="0.01" value="1">
      <div style="height:8px"></div>
      <div class="inline-label">Player portrait: zoom</div>
      <input id="playerZoom" type="range" min="0.2" max="6" step="0.01" value="1">
      <div style="height:8px"></div>

      <div class="row">
        <div class="half"><button id="teamReset" class="btn ghost">Reset Team</button></div>
        <div class="half"><button id="playerReset" class="btn ghost">Reset Player</button></div>
      </div>

      <div style="height:8px"></div>
      <label class="small">Effects</label>
      <div class="row">
        <button id="toggleHalftone" class="btn ghost">Halftone</button>
        <button id="toggleCircuit" class="btn ghost">Accents</button>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px">
      <button id="update" class="btn">Update Preview</button>
      <button id="export" class="btn ghost">Export PNG</button>
    </div>

    <div class="muted-note">Tip: Drag images inside the poster preview to reposition. Use zoom sliders to scale. Choose a background from the dropdown or upload your own.</div>
  </aside>

  <main class="stage" aria-label="Poster preview">
    <div class="canvas-card">
      <div class="preview-outer" id="previewWrap" title="Drag to move images, pinch to zoom">
        <canvas id="poster" width="760" height="760" aria-label="Poster canvas"></canvas>
      </div>

      <div class="bottom-controls">
        <div class="small">Preview (interactive)</div>
        <div class="right-controls">
          <button id="fitTeam" class="btn ghost">Fit Team</button>
          <button id="fitPlayer" class="btn ghost">Fit Player</button>
        </div>
      </div>
    </div>
  </main>

</div>

<script>
/* ------------------------
   Final Poster Generator
   - Auto-fit player name, background selector + upload
   - Put templates/WINNER (2).png in /templates/ or change DEFAULT_BG_URL
   ------------------------ */

const DEFAULT_BG_URL = 'templates/WINNER (2).png'; // put your uploaded Touchline blue image here
const CANVAS_PX = 760, EXPORT_PX = 2400;

const canvas = document.getElementById('poster');
canvas.width = CANVAS_PX; canvas.height = CANVAS_PX;
const ctx = canvas.getContext('2d', { alpha:false });

/* DOM */
const bgSelect = document.getElementById('bgSelect'), bgDrop = document.getElementById('bgDrop'), bgFile = document.getElementById('bgFile');
const teamFile = document.getElementById('teamFile'), teamDrop = document.getElementById('teamDrop');
const playerFile = document.getElementById('playerFile'), playerDrop = document.getElementById('playerDrop');
const logoFile = document.getElementById('logoFile'), logoDrop = document.getElementById('logoDrop');
const playerNameEl = document.getElementById('playerName'), ageLabel = document.getElementById('ageLabel');
const dateField = document.getElementById('dateField'), academy = document.getElementById('academy');
const teamZoom = document.getElementById('teamZoom'), playerZoom = document.getElementById('playerZoom');
const teamReset = document.getElementById('teamReset'), playerReset = document.getElementById('playerReset');
const updateBtn = document.getElementById('update'), exportBtn = document.getElementById('export');
const fitTeam = document.getElementById('fitTeam'), fitPlayer = document.getElementById('fitPlayer');
const toggleHalftone = document.getElementById('toggleHalftone'), toggleCircuit = document.getElementById('toggleCircuit');

const state = {
  backgroundType: 'touchline',
  backgroundImg: null, // custom uploaded bg if chosen
  templateImg: null, // will try to load DEFAULT_BG_URL for 'touchline'
  team: { img:null, x: CANVAS_PX*0.5, y: CANVAS_PX*0.32, scale:1, min:0.2, max:6, dragging:false, last:{x:0,y:0} },
  player: { img:null, x: CANVAS_PX*0.79, y: CANVAS_PX*0.63, scale:1, min:0.2, max:6, dragging:false, last:{x:0,y:0} },
  logo: { img:null },
  pointers: {},
  effects: { halftone:true, circuit:true }
};

/* Frames - coordinates tuned to match sample */
const FRAMES = {
  team: { x:44, y:140, w:520, h:320, r:22 },
  player: { x:560, y:500, w:200, h:240, r:14, angle:10 }
};

/* load default template background (Touchline Blue) */
(function loadDefaultBg(){
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = ()=> { state.templateImg = img; draw(); };
  img.onerror = ()=> { state.templateImg = null; draw(); };
  img.src = DEFAULT_BG_URL;
})();

/* file -> image helper */
function fileToImage(file, cb){
  const r = new FileReader();
  r.onload = e => { const img = new Image(); img.onload = ()=> cb(img); img.src = e.target.result; };
  r.readAsDataURL(file);
}

/* wire inputs and drop areas */
function setupDropArea(el, key){
  ['dragenter','dragover','dragleave','drop'].forEach(ev => el.addEventListener(ev, e => e.preventDefault()));
  el.addEventListener('drop', e=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(!f) return;
    fileToImage(f, img=>{
      if(key==='team') { state.team.img = img; fitLayer('team'); }
      if(key==='player') { state.player.img = img; fitLayer('player'); }
      if(key==='logo') { state.logo.img = img; }
      if(key==='bg') { state.backgroundImg = img; state.backgroundType = 'custom'; bgSelect.value = 'upload'; bgDrop.style.display='none'; }
      draw();
    });
  });
}
setupDropArea(teamDrop,'team'); setupDropArea(playerDrop,'player'); setupDropArea(logoDrop,'logo'); setupDropArea(bgDrop,'bg');

/* file inputs */
teamFile.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; fileToImage(f,img=>{ state.team.img=img; fitLayer('team'); draw(); });});
playerFile.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; fileToImage(f,img=>{ state.player.img=img; fitLayer('player'); draw(); });});
logoFile.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; fileToImage(f,img=>{ state.logo.img=img; draw(); });});
bgFile.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; fileToImage(f,img=>{ state.backgroundImg = img; state.backgroundType = 'custom'; bgDrop.style.display='none'; bgSelect.value='upload'; draw(); });});

/* background selector */
bgSelect.addEventListener('change', ()=>{
  const v = bgSelect.value;
  if(v==='upload'){ bgDrop.style.display = 'block'; state.backgroundType = 'custom'; }
  else { bgDrop.style.display = 'none'; state.backgroundType = v; }
  draw();
});

/* fit layer (cover) */
function fitLayer(which){
  const layer = which==='team'? state.team : state.player;
  const frame = which==='team'? FRAMES.team : FRAMES.player;
  if(!layer.img) return;
  const sx = frame.w / layer.img.width;
  const sy = frame.h / layer.img.height;
  const s = Math.max(sx, sy);
  layer.scale = s;
  layer.x = frame.x + frame.w/2;
  layer.y = frame.y + frame.h/2;
  if(which==='team') teamZoom.value = layer.scale;
  else playerZoom.value = layer.scale;
}

/* resets */
teamReset.addEventListener('click', ()=>{ state.team.scale=1; state.team.x=CANVAS_PX*0.5; state.team.y=CANVAS_PX*0.32; teamZoom.value=state.team.scale; draw(); });
playerReset.addEventListener('click', ()=>{ state.player.scale=1; state.player.x=CANVAS_PX*0.79; state.player.y=CANVAS_PX*0.63; playerZoom.value=state.player.scale; draw(); });
fitTeam.addEventListener('click', ()=>{ fitLayer('team'); draw(); });
fitPlayer.addEventListener('click', ()=>{ fitLayer('player'); draw(); });

teamZoom.addEventListener('input', ()=>{ state.team.scale = parseFloat(teamZoom.value); draw(); });
playerZoom.addEventListener('input', ()=>{ state.player.scale = parseFloat(playerZoom.value); draw(); });

toggleHalftone.addEventListener('click', ()=>{ state.effects.halftone = !state.effects.halftone; toggleHalftone.classList.toggle('btn'); draw(); });
toggleCircuit.addEventListener('click', ()=>{ state.effects.circuit = !state.effects.circuit; toggleCircuit.classList.toggle('btn'); draw(); });

updateBtn.addEventListener('click', draw);

/* pointer interactions */
let active = null;
function getPointerPos(evt){
  const r = canvas.getBoundingClientRect();
  return { x: (evt.clientX - r.left) * (canvas.width / r.width), y: (evt.clientY - r.top) * (canvas.height / r.height) };
}
canvas.addEventListener('pointerdown', ev=>{
  ev.preventDefault();
  canvas.setPointerCapture && canvas.setPointerCapture(ev.pointerId);
  state.pointers[ev.pointerId] = {x:ev.clientX, y:ev.clientY};
  const p = getPointerPos(ev);
  const pf = FRAMES.player, tf = FRAMES.team;
  if(pointInParallelogram(p.x,p.y,pf)){ active = state.player; active.dragging=true; active.last={x:p.x,y:p.y}; return; }
  if(pointInRect(p.x,p.y,tf)){ active = state.team; active.dragging=true; active.last={x:p.x,y:p.y}; return; }
  active = null;
});
canvas.addEventListener('pointermove', ev=>{
  state.pointers[ev.pointerId] = {x:ev.clientX, y:ev.clientY};
  const keys = Object.keys(state.pointers);
  if(keys.length===2){
    const a = state.pointers[keys[0]], b = state.pointers[keys[1]];
    const dist = Math.hypot(a.x-b.x, a.y-b.y);
    if(state._lastPinchDist){
      const delta = dist - state._lastPinchDist;
      const factor = 1 + delta/250;
      const mid = {x:(a.x+b.x)/2, y:(a.y+b.y)/2};
      const r = canvas.getBoundingClientRect();
      const midC = {x:(mid.x - r.left)*(canvas.width/r.width), y:(mid.y - r.top)*(canvas.height/r.height)};
      if(pointInParallelogram(midC.x, midC.y, FRAMES.player)){
        const old = state.player.scale;
        state.player.scale = Math.max(state.player.min, Math.min(state.player.max, state.player.scale * factor));
        const mx = midC.x, my = midC.y;
        const sx = (mx - state.player.x) * (state.player.scale/old - 1);
        const sy = (my - state.player.y) * (state.player.scale/old - 1);
        state.player.x -= sx; state.player.y -= sy; playerZoom.value = state.player.scale;
      } else {
        const old = state.team.scale;
        state.team.scale = Math.max(state.team.min, Math.min(state.team.max, state.team.scale * factor));
        const mx = midC.x, my = midC.y;
        const sx = (mx - state.team.x) * (state.team.scale/old - 1);
        const sy = (my - state.team.y) * (state.team.scale/old - 1);
        state.team.x -= sx; state.team.y -= sy; teamZoom.value = state.team.scale;
      }
      draw();
    }
    state._lastPinchDist = dist;
    return;
  }

  if(!active || !active.dragging) return;
  const p = getPointerPos(ev);
  const dx = p.x - active.last.x, dy = p.y - active.last.y;
  active.x += dx; active.y += dy; active.last = {x:p.x,y:p.y};
  draw();
});
canvas.addEventListener('pointerup', ev=>{
  delete state.pointers[ev.pointerId];
  if(Object.keys(state.pointers).length<2) state._lastPinchDist = null;
  if(active) active.dragging=false; active = null;
  canvas.releasePointerCapture && canvas.releasePointerCapture(ev.pointerId);
});
canvas.addEventListener('wheel', ev=>{
  ev.preventDefault();
  const p = getPointerPos(ev);
  if(pointInParallelogram(p.x,p.y,FRAMES.player)){
    const delta = -ev.deltaY * 0.0015;
    const old = state.player.scale;
    state.player.scale = Math.max(state.player.min, Math.min(state.player.max, state.player.scale * (1+delta)));
    const mx = p.x, my = p.y;
    const sx = (mx - state.player.x) * (state.player.scale/old - 1);
    const sy = (my - state.player.y) * (state.player.scale/old - 1);
    state.player.x -= sx; state.player.y -= sy; playerZoom.value = state.player.scale;
    draw();
  } else if(pointInRect(p.x,p.y,FRAMES.team)){
    const delta = -ev.deltaY * 0.0015;
    const old = state.team.scale;
    state.team.scale = Math.max(state.team.min, Math.min(state.team.max, state.team.scale * (1+delta)));
    const mx = p.x, my = p.y;
    const sx = (mx - state.team.x) * (state.team.scale/old - 1);
    const sy = (my - state.team.y) * (state.team.scale/old - 1);
    state.team.x -= sx; state.team.y -= sy; teamZoom.value = state.team.scale;
    draw();
  }
}, { passive:false });

function pointInRect(px,py,frame){ return px>=frame.x && px<=frame.x+frame.w && py>=frame.y && py<=frame.y+frame.h; }
function pointInParallelogram(px,py,frame){
  const x=frame.x,y=frame.y,w=frame.w,h=frame.h,angle=frame.angle||0;
  const skew = Math.tan((angle||0)*Math.PI/180)*h;
  const pA={x:x+skew,y:y}, pB={x:x+skew+w,y:y}, pC={x:x+w,y:y+h}, pD={x:x,y:y+h};
  return pointInPoly(px,py,[pA,pB,pC,pD]);
}
function pointInPoly(x,y,poly){ let inside=false; for(let i=0,j=poly.length-1;i<poly.length;j=i++){ const xi=poly[i].x, yi=poly[i].y, xj=poly[j].x, yj=poly[j].y; const intersect = ((yi>y)!=(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi)+xi); if(intersect) inside=!inside; } return inside; }

/* draw helpers */
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

function drawBackground(){
  // choose background by state.backgroundType
  if(state.backgroundType==='touchline'){
    if(state.templateImg) ctx.drawImage(state.templateImg,0,0,CANVAS_PX,CANVAS_PX);
    else {
      const g=ctx.createLinearGradient(0,0,CANVAS_PX,CANVAS_PX); g.addColorStop(0,'#0a3a73'); g.addColorStop(1,'#04294b'); ctx.fillStyle=g; ctx.fillRect(0,0,CANVAS_PX,CANVAS_PX);
    }
  } else if(state.backgroundType==='custom' && state.backgroundImg){
    ctx.drawImage(state.backgroundImg,0,0,CANVAS_PX,CANVAS_PX);
  } else if(state.backgroundType==='red'){
    const g=ctx.createLinearGradient(0,0,CANVAS_PX,CANVAS_PX); g.addColorStop(0,'#7a0b0b'); g.addColorStop(1,'#2b0f0f'); ctx.fillStyle=g; ctx.fillRect(0,0,CANVAS_PX,CANVAS_PX);
  } else if(state.backgroundType==='gold'){
    const g=ctx.createLinearGradient(0,0,CANVAS_PX,CANVAS_PX); g.addColorStop(0,'#e6b800'); g.addColorStop(1,'#6f4f00'); ctx.fillStyle=g; ctx.fillRect(0,0,CANVAS_PX,CANVAS_PX);
  } else if(state.backgroundType==='green'){
    const g=ctx.createLinearGradient(0,0,CANVAS_PX,CANVAS_PX); g.addColorStop(0,'#1b7a3a'); g.addColorStop(1,'#073a20'); ctx.fillStyle=g; ctx.fillRect(0,0,CANVAS_PX,CANVAS_PX);
  } else {
    // fallback
    ctx.fillStyle='#04294b'; ctx.fillRect(0,0,CANVAS_PX,CANVAS_PX);
  }

  // faint repeating wordmark if using touchline or gradients
  if(state.backgroundType==='touchline' || state.backgroundType==='red' || state.backgroundType==='gold' || state.backgroundType==='green'){
    ctx.save();
    ctx.globalAlpha = 0.05;
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 100px Poppins';
    ctx.textAlign = 'center';
    for(let y=-80;y<CANVAS_PX+180;y+=120){
      for(let x=-40;x<CANVAS_PX+40;x+=330){
        ctx.fillText('TOUCHLINE', x, y, 300);
      }
    }
    ctx.restore();
  }

  // halftone if active
  if(state.effects.halftone){
    ctx.save();
    const step = 12;
    for(let y=20;y<CANVAS_PX;y+=step){
      for(let x=20;x<CANVAS_PX;x+=step){
        const d = Math.hypot(x-60,y-60);
        const a = Math.max(0, 0.35 - d/700);
        if(a>0.01){
          ctx.fillStyle = `rgba(255,255,255,${a*0.06})`;
          ctx.beginPath(); ctx.arc(x,y, (1 + a*6), 0, Math.PI*2); ctx.fill();
        }
      }
    }
    ctx.restore();
  }

  // circuit accent
  if(state.effects.circuit){
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.04)';
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(60, CANVAS_PX-120); ctx.lineTo(220, CANVAS_PX-120); ctx.lineTo(260, CANVAS_PX-160); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(320, CANVAS_PX-100); ctx.lineTo(420, CANVAS_PX-100); ctx.stroke();
    ctx.restore();
  }
}

/* draw team frame */
function drawTeam(){
  const tf = FRAMES.team;
  // rounded rect background
  ctx.save(); roundRect(ctx, tf.x, tf.y, tf.w, tf.h, tf.r); ctx.fillStyle='rgba(8,18,36,0.35)'; ctx.fill(); ctx.clip();
  if(state.team.img){
    const img = state.team.img;
    const w = img.width * state.team.scale; const h = img.height * state.team.scale;
    const dx = state.team.x - w/2; const dy = state.team.y - h/2;
    ctx.drawImage(img, dx, dy, w, h);
    // vignette
    ctx.fillStyle = 'rgba(2,6,14,0.22)'; ctx.fillRect(tf.x, tf.y + tf.h - 100, tf.w, 100);
  } else {
    ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(tf.x, tf.y, tf.w, tf.h);
  }
  ctx.restore();

  // headline and age badge & date
  ctx.save();
  ctx.fillStyle = '#fff';
  ctx.font = '800 40px Montserrat';
  ctx.textAlign = 'left';
  ctx.shadowColor = 'rgba(2,8,20,0.6)'; ctx.shadowBlur = 12;
  ctx.fillText('PLAYER OF THE DAY', 36, 66);

  // age parallelogram top-right
  const ageText = (ageLabel.value||'').toUpperCase();
  ctx.font = '700 16px Montserrat';
  const ageW = Math.max(120, ctx.measureText(ageText).width + 36);
  const ageX = CANVAS_PX - ageW - 36, ageY = 26, ageH = 40;
  ctx.beginPath(); const s = Math.tan(-8*Math.PI/180)*ageH;
  ctx.moveTo(ageX + s, ageY); ctx.lineTo(ageX + s + ageW, ageY); ctx.lineTo(ageX + ageW, ageY + ageH); ctx.lineTo(ageX, ageY + ageH); ctx.closePath();
  ctx.fillStyle = '#1b66c4'; ctx.fill();
  ctx.fillStyle = '#fff'; ctx.textAlign='center';
  ctx.fillText(ageText, ageX + ageW/2, ageY + ageH/2 + 1);

  // date below team frame center
  ctx.fillStyle = '#cfe6ff'; ctx.font = '600 16px Poppins';
  ctx.textAlign = 'center';
  ctx.fillText((dateField.value||''), tf.x + 420, tf.y + tf.h + 40);
  ctx.restore();
}

/* draw player parallelogram & name badge with auto-fit font */
function drawPlayer(){
  const pf = FRAMES.player;
  // shadow base
  ctx.save(); ctx.shadowColor = 'rgba(3,12,28,0.7)'; ctx.shadowBlur = 26;
  const s = Math.tan((pf.angle||0)*Math.PI/180)*pf.h;
  ctx.beginPath(); ctx.moveTo(pf.x + s, pf.y); ctx.lineTo(pf.x + s + pf.w, pf.y); ctx.lineTo(pf.x + pf.w, pf.y + pf.h); ctx.lineTo(pf.x, pf.y + pf.h); ctx.closePath();
  ctx.fillStyle = '#071226'; ctx.fill(); ctx.restore();

  // clip to parallelogram and draw player img
  ctx.save();
  const s2 = Math.tan((pf.angle||0)*Math.PI/180)*pf.h;
  ctx.beginPath(); ctx.moveTo(pf.x + s2, pf.y); ctx.lineTo(pf.x + s2 + pf.w, pf.y); ctx.lineTo(pf.x + pf.w, pf.y + pf.h); ctx.lineTo(pf.x, pf.y + pf.h); ctx.closePath();
  ctx.clip();
  if(state.player.img){
    const img = state.player.img;
    const w = img.width * state.player.scale; const h = img.height * state.player.scale;
    const dx = state.player.x - w/2; const dy = state.player.y - h/2;
    ctx.drawImage(img, dx, dy, w, h);
  } else {
    ctx.fillStyle = '#071224'; ctx.fillRect(pf.x, pf.y, pf.w, pf.h);
  }
  ctx.restore();

  // stroke
  ctx.save(); ctx.lineWidth = 6; ctx.strokeStyle = 'rgba(27,102,196,0.95)';
  ctx.beginPath(); ctx.moveTo(pf.x + s2, pf.y); ctx.lineTo(pf.x + s2 + pf.w, pf.y); ctx.lineTo(pf.x + pf.w, pf.y + pf.h); ctx.lineTo(pf.x, pf.y + pf.h); ctx.closePath(); ctx.stroke(); ctx.restore();

  // name badge: larger height + auto-fit font
  const name = (playerNameEl.value||'PLAYER').toUpperCase();
  ctx.save();
  // compute name badge size
  ctx.font = '800 20px Montserrat';
  const baseNameW = Math.max(180, ctx.measureText(name).width + 60);
  const nameH = 56; // increased height to avoid clipping
  const nameX = pf.x + pf.w/2 - baseNameW/2;
  const nameY = 700;

  // draw parallelogram badge background
  const ang = 6;
  const s3 = Math.tan(ang*Math.PI/180)*nameH;
  ctx.beginPath();
  ctx.moveTo(nameX + s3, nameY);
  ctx.lineTo(nameX + s3 + baseNameW, nameY);
  ctx.lineTo(nameX + baseNameW, nameY + nameH);
  ctx.lineTo(nameX, nameY + nameH);
  ctx.closePath();
  ctx.fillStyle = '#1b66c4'; ctx.fill();

  // auto-scale font to fit width
  ctx.fillStyle = '#fff'; ctx.textAlign='center';
  let fontSize = 28;
  ctx.font = `800 ${fontSize}px Montserrat`;
  while(ctx.measureText(name).width > baseNameW - 24 && fontSize > 12){
    fontSize -= 1;
    ctx.font = `800 ${fontSize}px Montserrat`;
  }
  const textY = nameY + nameH/2 + (fontSize*0.22);
  ctx.fillText(name, nameX + baseNameW/2, textY);
  ctx.restore();

  // academy below name
  ctx.save(); ctx.fillStyle = '#e7f3ff'; ctx.font = '600 13px Poppins'; ctx.textAlign='center';
  ctx.fillText((academy.value||'').toUpperCase(), pf.x + -420, 20 + nameH + 22);
  ctx.restore();
}

/* footer & logo */
function drawFooter(){
  ctx.save();
  if(state.logo.img){
    const lw=120, lh=120;
    ctx.drawImage(state.logo.img, 36, CANVAS_PX - lh - 36, lw, lh);
  }else {
    // default Touchline logo placeholder
    const defaultLogo = new Image();
  defaultLogo.src = './logo.png'; // make sure this file is in the same folder as your HTML
  defaultLogo.onload = () => {
    const lw = 120, lh = 120;
    ctx.drawImage(defaultLogo, 36, CANVAS_PX - lh - 36, lw, lh);
  }
}
  
}

/* central draw */
function draw(){
  ctx.clearRect(0,0,CANVAS_PX,CANVAS_PX);
  drawBackground();
  drawTeam();
  drawPlayer();
  drawFooter();
}
draw();

/* export to high res */
exportBtn.addEventListener('click', ()=>{
  const size = EXPORT_PX;
  const ecanvas = document.createElement('canvas'); ecanvas.width=size; ecanvas.height=size;
  const ectx = ecanvas.getContext('2d', { alpha:false });
  const sf = size / CANVAS_PX;

  // background simplified copy of drawBackground but scaled:
  if(state.backgroundType==='touchline'){
    if(state.templateImg) ectx.drawImage(state.templateImg,0,0,size,size);
    else { const g=ectx.createLinearGradient(0,0,size,size); g.addColorStop(0,'#0a3a73'); g.addColorStop(1,'#04294b'); ectx.fillStyle=g; ectx.fillRect(0,0,size,size); }
  } else if(state.backgroundType==='custom' && state.backgroundImg){ ectx.drawImage(state.backgroundImg,0,0,size,size); }
  else if(state.backgroundType==='red'){ const g=ectx.createLinearGradient(0,0,size,size); g.addColorStop(0,'#7a0b0b'); g.addColorStop(1,'#2b0f0f'); ectx.fillStyle=g; ectx.fillRect(0,0,size,size); }
  else if(state.backgroundType==='gold'){ const g=ectx.createLinearGradient(0,0,size,size); g.addColorStop(0,'#e6b800'); g.addColorStop(1,'#6f4f00'); ectx.fillStyle=g; ectx.fillRect(0,0,size,size); }
  else if(state.backgroundType==='green'){ const g=ectx.createLinearGradient(0,0,size,size); g.addColorStop(0,'#1b7a3a'); g.addColorStop(1,'#073a20'); ectx.fillStyle=g; ectx.fillRect(0,0,size,size); }
  // subtle pattern/hafltone for export if desired (skipped heavy processing for brevity)

  // draw team frame scaled
  const tf = FRAMES.team;
  ectx.save(); roundRect(ectx, tf.x*sf, tf.y*sf, tf.w*sf, tf.h*sf, tf.r*sf); ectx.clip();
  if(state.team.img){
    const img = state.team.img;
    const w = img.width * state.team.scale * sf;
    const h = img.height * state.team.scale * sf;
    const dx = (state.team.x*sf) - w/2, dy = (state.team.y*sf) - h/2;
    ectx.drawImage(img, dx, dy, w, h);
    ectx.fillStyle='rgba(2,6,14,0.22)'; ectx.fillRect(tf.x*sf, (tf.y*sf + tf.h*sf - 100*sf), tf.w*sf, 100*sf);
  }
  ectx.restore();

  // heading + age
  ectx.fillStyle = '#fff'; ectx.font = '800 ' + (40*sf) + 'px Montserrat'; ectx.textAlign='left';
  ectx.fillText('PLAYER OF THE DAY', 36*sf, 66*sf);
  const ageText=(ageLabel.value||'').toUpperCase(); ectx.font = '700 ' + (16*sf) + 'px Montserrat';
  const ageW = Math.max(120*sf, ectx.measureText(ageText).width + 36*sf);
  const ageX = size - ageW - 36*sf, ageY=26*sf, ageH=40*sf;
  ectx.beginPath(); const ss = Math.tan(-8*Math.PI/180)*ageH;
  ectx.moveTo(ageX + ss, ageY); ectx.lineTo(ageX + ss + ageW, ageY); ectx.lineTo(ageX + ageW, ageY + ageH); ectx.lineTo(ageX, ageY + ageH); ectx.closePath();
  ectx.fillStyle = '#1b66c4'; ectx.fill(); ectx.fillStyle = '#fff'; ectx.textAlign='center'; ectx.fillText(ageText, ageX + ageW/2, ageY + ageH/2 + (1*sf));

  // player parallelogram section
  const pf = FRAMES.player;
  const sAng = Math.tan((pf.angle||0)*Math.PI/180) * pf.h * sf;
  ectx.save();
  ectx.beginPath();
  ectx.moveTo(pf.x*sf + sAng, pf.y*sf); ectx.lineTo(pf.x*sf + sAng + pf.w*sf, pf.y*sf);
  ectx.lineTo(pf.x*sf + pf.w*sf, (pf.y + pf.h)*sf); ectx.lineTo(pf.x*sf, (pf.y + pf.h)*sf); ectx.closePath();
  ectx.clip();
  if(state.player.img){
    const img = state.player.img;
    const w = img.width * state.player.scale * sf;
    const h = img.height * state.player.scale * sf;
    const dx = (state.player.x*sf) - w/2, dy = (state.player.y*sf) - h/2;
    ectx.drawImage(img, dx, dy, w, h);
  }
  ectx.restore();
  // stroke
  ectx.save(); ectx.lineWidth = 24*sf; ectx.strokeStyle='rgba(27,102,196,0.95)'; ectx.beginPath();
  ectx.moveTo(pf.x*sf + sAng, pf.y*sf); ectx.lineTo(pf.x*sf + sAng + pf.w*sf, pf.y*sf);
  ectx.lineTo(pf.x*sf + pf.w*sf, (pf.y + pf.h)*sf); ectx.lineTo(pf.x*sf, (pf.y + pf.h)*sf); ectx.closePath(); ectx.stroke(); ectx.restore();

  // name badge scaled with auto font sizing
  ectx.font = '800 ' + (28*sf) + 'px Montserrat';
  const nameText = (playerNameEl.value||'').toUpperCase();
  let baseNameW = Math.max(180*sf, ectx.measureText(nameText).width + 60*sf);
  const nameH = 56*sf; const nameX = (pf.x + pf.w/2)*sf - baseNameW/2; const nameY = (pf.y + pf.h + 12)*sf;
  const ang2 = 6; const sName = Math.tan(ang2*Math.PI/180) * nameH;
  ectx.beginPath(); ectx.moveTo(nameX + sName, nameY); ectx.lineTo(nameX + sName + baseNameW, nameY); ectx.lineTo(nameX + baseNameW, nameY + nameH); ectx.lineTo(nameX, nameY + nameH); ectx.closePath(); ectx.fillStyle = '#1b66c4'; ectx.fill();
  // auto font scale
  let fsz = 28*sf; ectx.font = `800 ${fsz}px Montserrat`;
  while(ectx.measureText(nameText).width > baseNameW - 24*sf && fsz>10*sf){ fsz -= 1*sf; ectx.font = `800 ${fsz}px Montserrat`; }
  ectx.fillStyle = '#fff'; ectx.textAlign='center'; ectx.fillText(nameText, nameX + baseNameW/2, nameY + nameH/2 + (fsz*0.22));

  // academy text
  ectx.fillStyle = '#e7f3ff'; ectx.font = '600 ' + (14*sf) + 'px Poppins'; ectx.textAlign='center';
  ectx.fillText((academy.value||'').toUpperCase(), size/2, nameY + nameH + 28*sf);

  // footer logo and contact
  ectx.save();
  if(state.logo.img){
    const lw = 120*sf, lh = 120*sf; ectx.drawImage(state.logo.img, 36*sf, size - lh - 36*sf, lw, lh);
  } else {
    ectx.fillStyle = '#071224'; roundRect(ectx,36*sf,size - 140*sf,120*sf,120*sf,12*sf); ectx.fill();
    ectx.fillStyle = '#cfe6ff'; ectx.font = '800 ' + (20*sf) + 'px Montserrat'; ectx.textAlign='center'; ectx.fillText('TL', 36*sf + 60*sf, size - 80*sf);
  }
  ectx.fillStyle = '#cfe6ff'; ectx.font = '600 ' + (13*sf) + 'px Poppins'; ectx.textAlign='left'; ectx.fillText('+971 58 569 8277', 36*sf + 140*sf, size - 52*sf); ectx.fillText('www.touchlinesport.ae', 36*sf + 140*sf, size - 34*sf);
  ectx.restore();

  // download
  const url = ecanvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url;
  const safeName = (playerNameEl.value||'player').replace(/\s+/g,'_').toLowerCase();
  a.download = `${safeName}_poster.png`; a.click();
});

/* init loads & draw finished earlier; allow sample default template loaded at page load */

/* If user changes inputs, update live */
[playerNameEl, ageLabel, dateField, academy].forEach(el => el.addEventListener('input', draw));

/* Show/hide background upload area rules */
bgSelect.addEventListener('change', ()=>{ if(bgSelect.value === 'upload') bgDrop.style.display = 'block'; else bgDrop.style.display='none'; });

/* done */
</script>
</body>
</html>
